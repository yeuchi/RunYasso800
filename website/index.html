<!DOCTYPE html>
<!-- 
    Description: RunYasso javascript website for reviewing data.

    Author: Chi (CT) Yeung

    Date: August 15, 2020

    Reference:

    Google map
    https://developers.google.com/maps/documentation/javascript/examples/polyline-simple 

    Time with no Am/Pm
    https://stackoverflow.com/questions/45283030/html5-input-type-time-without-am-pm-and-with-min-max

-->
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>RunYasso800</title>
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    
    <!-- Use this for your personal domain 
      <script defer src="https://maps.googleapis.com/maps/api/js?AIzaSyAThDBNxCs_gHlusYlCPv765XjyRKz4-hY&callback=initMap">
    </script> -->

    <!-- yeuchi's domain -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC76sHFtIIhGRNQHyaOEViocPW5QXOai_o&callback=initMap"
type="text/javascript"></script> 

    <script src="Demo.js"></script>
    <script src="Splits.js"></script>
    <script src="Steps.js"></script>

    <style>
      #btnGoal {
        display: inline-block;
        cursor: pointer;
      }
      
      #timeGoal {
        display: inline-block;
      }

      .divTime {
        margin-bottom: 10px;
      }

      #resizable { 
        width: 250px; 
        height: 150px; 
        padding: 0.5em; 
        position: absolute;
        overflow: hidden;
        z-index: 200;
        }
      #btnSteps { 
        text-align: center; 
        width: 100%;
        cursor: pointer;
        }

      textarea {
        overflow-y: scroll;
        width: 100%;
        height: 90%;
        resize: none; /* Remove this if you want the user to resize the textarea */
      }

      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .without_ampm::-webkit-datetime-edit-ampm-field {
        display: none;
      }
      input[type=time]::-webkit-clear-button {
        -webkit-appearance: none;
        -moz-appearance: none;
        -o-appearance: none;
        -ms-appearance:none;
        appearance: none;
        margin: -10px; 
      }
    </style>

  </head>

  <script>
    let map;
    var goal = 240;
    var demo = new Demo();
    var splits = new Splits(demo);
    var steps = new Steps(demo);

    function setColor(index, time) {
      if(index%2==0) {
        return "blue";
      }
      
      return time < goal ? "green" : "red";
    }

    function initMarkers(map, list, goal) {
      for(var i=0; i<list.length; i++) {
        // set color
        var color = setColor(i, list[i].time)
        var j = i+1;
        var image = {
        url: "https://raw.githubusercontent.com/Concept211/Google-Maps-Markers/master/images/marker_"+color+j+".png",
        };

        var marker = new google.maps.Marker({
          position: list[i],
          icon: image
        });

        marker.setMap(map);
      }
    }

    function initPath(map, list) {
      var runPath = new google.maps.Polyline({
        path: list,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
      });

      runPath.setMap(map);
    }

    function initMap() {
      var runPath = steps.isEmpty() ? steps.getDemo() : steps.getAll();
      var markers = splits.isEmpty() ? splits.getDemo() : splits.getAll();

      if(typeof google != 'undefined') {
        var midpoint = splits.findCenter()
        if(midpoint != null) {
          map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: midpoint,
            mapTypeId: 'terrain'
          });
        }

        initPath(map, runPath)
        initMarkers(map, markers, goal)
      }
    }

    $( function() {
      $( "#resizable" ).resizable();
    } );

    function filterSteps(str) {
      if(str!=null) {
        for(var i=0; i<str.length; i++) {
          if(str.charAt(i) == '[') {
            return str.substring(i, str.length) 
          }
        }
      }
      return str;
    }

    $(document).ready(function() {
      // init Steps textarea
      var str = JSON.stringify(demo.getAll())
      $("#txtSteps").val(str)

      // click button Steps listener
      $("#btnSteps").on('click', function() {
        var str = $("#txtSteps").val();
        str = filterSteps(str)
        
        var goodSplits = splits.deserialize(str);
        var goodSteps = steps.deserialize(str);
        if(goodSplits && goodSteps)
          initMap();
        else 
          alert("Steps load error\n Your Steps JSON Array please.")
      });

      // click button Goal listener
      $("#btnGoal").on('click', function() {
        var time = $('#timeGoal').val().split(':')
        goal = parseInt(time[0]) * 60 + parseInt(time[1]);

        initMap();
      });

      // start map
      initMap()
    });
  </script>

  <body>
    <div id="resizable" class="ui-widget-content">
      <!-- Goal -->
      <div class="divTime">
        <input id="btnGoal" type="submit" value="Goal">
        <input id="timeGoal" type="time" value="04:00" class="without_ampm" >
      </div>

      <!-- Steps -->
      <input id="btnSteps" type="submit" value="Steps">
      <textarea id="txtSteps"></textarea>
    </div> 

    <div id="map">

  </body>
</html>